<workflowGraph name="blatDnaAgainstGenome">
    <param name="dataDir"/>
    <param name="maxIntronSize"/>
    <param name="organismAbbrev"/>
    <param name="targetSeqsDir"/>
    <param name="targetExtDbName"/>
    <param name="queryFile"/>
    <param name="queryTable"/>
    <param name="queryExtDbName"/>

    <constant name="blatOutputFile">$$dataDir$$/blat.out</constant>

    <step name="makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="makeBlatNextflowConfig" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeBlatNextflowConfig" >
      <paramValue name="maxIntronSize">$$maxIntronSize$$</paramValue>
      <paramValue name="fastaSubsetSize">1</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <paramValue name="queryType">dna</paramValue>
      <paramValue name="dbType">dna</paramValue>
      <paramValue name="databasePath">$$targetSeqsDir$$</paramValue>
      <paramValue name="outputDir">$$dataDir$$/results</paramValue>
      <paramValue name="analysisDir">$$dataDir$$</paramValue>
      <paramValue name="configFileName">nextflow.config</paramValue>
      <paramValue name="blatParams"></paramValue>
      <paramValue name="trans">false</paramValue>
      <paramValue name="initialMemory">4000</paramValue>
      <paramValue name="increasedMemory">12000</paramValue>
      <paramValue name="maxForks">40</paramValue>
      <paramValue name="maxRetries">2</paramValue>
      <depends name="makeDataDir"/>
    </step>

    <step name="mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="makeBlatNextflowConfig"/>
    </step>

    <step name="runBlatClusterTask" stepClass="ReFlow::StepClasses::RunAndMonitorNextflow">
      <paramValue name="workingDir">$$dataDir$$</paramValue>
      <paramValue name="resultsDir">$$dataDir$$/results</paramValue>
      <paramValue name="nextflowConfigFile">$$dataDir$$/nextflow.config</paramValue>
      <paramValue name="nextflowWorkflow">VEuPathDB/blat</paramValue>
      <paramValue name="isGitRepo">true</paramValue>
      <depends name="mirrorToCluster"/>
    </step>

    <step name="mirrorFromCluster" stepClass="ReFlow::StepClasses::MirrorFromComputeCluster" stepLoadTypes="fromCluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/results</paramValue>
      <paramValue name="outputDir">$$dataDir$$/master/mainresult</paramValue>
      <paramValue name="outputFiles">out.psl</paramValue>
      <paramValue name="deleteAfterCopy">true</paramValue>
      <depends name="runBlatClusterTask"/>
    </step>

    <step name="fixGenomeSourceIdsInBlatResultFile" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::FixGenomeSourceIdsInBlatResultFile">
      <paramValue name="inputFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <depends name="mirrorFromCluster"/>
     </step>

    <step name="insertBlatAlignment" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertBlatAlignment" stepLoadTypes="plugin">
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="targetExtDbName">$$targetExtDbName$$</paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryExtDbName">$$queryExtDbName$$</paramValue>
      <paramValue name="queryTable">$$queryTable$$</paramValue>
      <paramValue name="queryIdRegex">>(\\d+)</paramValue>
      <paramValue name="action">load</paramValue>
      <paramValue name="percentTop"></paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <depends name="fixGenomeSourceIdsInBlatResultFile"/>
    </step>

    <step name="setBestBlatAlignment" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertBlatAlignment" stepLoadTypes="plugin">
      <paramValue name="organismAbbrev">$$organismAbbrev$$</paramValue>
      <paramValue name="targetExtDbName">$$targetExtDbName$$</paramValue>
      <paramValue name="queryExtDbName">$$queryExtDbName$$</paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">$$queryTable$$</paramValue>
      <paramValue name="queryIdRegex">>(\\d+)</paramValue> <!-- This is ignored -->
      <paramValue name="action">setbest</paramValue>
      <paramValue name="percentTop">100</paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$queryFile$$</paramValue>
      <depends name="insertBlatAlignment"/>
    </step>

</workflowGraph>
